<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>í”„ë­í¬ ì˜¤ë²„ë ˆì´ (GPS + ìˆ˜ìµ)</title>
<script src="https://cdn.jsdelivr.net/npm/@rtirl/api"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: transparent;
    color: white;
  }

  /* í•˜ë‹¨ë°” - í•œ ì¤„ ê³ ì •, ê°„ê²© ìµœì†Œí™” */
  #overlay {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 36px;
    background: rgba(0, 0, 0, 0.70);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 13px;
    padding: 0 10px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
    white-space: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    gap: 8px;
  }

  /* ì™¼ìª½ ì„¹ì…˜ (GPS + ìˆ˜ìµ) */
  .left-section {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  /* ì˜¤ë¥¸ìª½ ì„¹ì…˜ (ë‚ ì”¨/ì‹œê°„/ë°°í„°ë¦¬ + ë¡œê³ ) */
  .right-section {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    margin-left: auto;
  }

  /* ê³µí†µ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
  .section {
    display: flex;
    align-items: center;
    gap: 3px;
    flex-shrink: 0;
  }

  .icon {
    height: 18px;
    width: auto;
    opacity: 0.9;
    transition: opacity 0.3s ease;
    flex-shrink: 0;
  }

  .icon:hover {
    opacity: 1;
  }

  /* ê±°ë¦¬ - ì—°í•œ í•˜ëŠ˜ìƒ‰ */
  #distance {
    font-weight: 600;
    color: #7df9ff;
    text-shadow: 0 0 8px rgba(125, 249, 255, 0.5);
    font-size: 13px; /* í†µì¼ */
    margin-right: 2px;
  }

  /* ìˆ˜ìµ ë°ì´í„° ìŠ¤íƒ€ì¼ */
  .revenue-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(255, 255, 255, 0.1);
    padding: 3px 8px;
    border-radius: 16px;
    flex-shrink: 0;
  }

  .revenue-item {
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .revenue-label {
    font-size: 11px; /* ë ˆì´ë¸”ì€ ì•½ê°„ ì‘ê²Œ ìœ ì§€ */
    opacity: 0.7;
  }

  .revenue-value {
    font-weight: 600;
    font-size: 13px; /* ê°’ì€ 13pxë¡œ í†µì¼ */
  }

  /* ìˆ˜ìµ ìƒ‰ìƒ */
  #daily-value { 
    color: #ffd700;
    text-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
  }
  
  #weekly-value { 
    color: #c77dff;
    text-shadow: 0 0 8px rgba(199, 125, 255, 0.3);
  }
  
  #monthly-value { 
    color: #ff7f7f;
    text-shadow: 0 0 8px rgba(255, 127, 127, 0.3);
  }

  /* ìƒíƒœ í‘œì‹œ */
  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #7df9ff;
    display: inline-block;
    margin-right: 3px;
    animation: pulse 2s infinite;
    flex-shrink: 0;
    box-shadow: 0 0 8px rgba(125, 249, 255, 0.5);
  }

  .status-dot.connecting {
    background: #FF9800;
    box-shadow: 0 0 8px rgba(255, 152, 0, 0.5);
  }

  .status-dot.error {
    background: #F44336;
    box-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
  }

  @keyframes pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
  }

  /* ===== ë‚ ì”¨, ì‹œê°„, ë°°í„°ë¦¬ í†µì¼ ìŠ¤íƒ€ì¼ ===== */
  /* ëª¨ë“  info-itemì— ë™ì¼í•œ ìŠ¤íƒ€ì¼ ì ìš© */
  .info-item {
    display: flex;
    align-items: center;
    gap: 3px;
    color: #ffffff;  /* ëª¨ë“  í…ìŠ¤íŠ¸ í°ìƒ‰ í†µì¼ */
    font-size: 13px;  /* ëª¨ë“  í°íŠ¸ í¬ê¸° 13px í†µì¼ */
    font-weight: 400; /* ì¼ë°˜ êµµê¸° í†µì¼ */
    text-shadow: none; /* í…ìŠ¤íŠ¸ ê·¸ë¦¼ì ì œê±° */
    opacity: 1;       /* íˆ¬ëª…ë„ í†µì¼ */
  }

  .info-item span:first-child {
    min-width: 18px;
    text-align: center;
    font-size: 13px;  /* ì•„ì´ì½˜ í¬ê¸°ë„ í…ìŠ¤íŠ¸ì™€ ë™ì¼í•˜ê²Œ */
  }

  .info-item span:last-child {
    color: #ffffff;   /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ í°ìƒ‰ í†µì¼ */
    font-size: 13px;  /* í°íŠ¸ í¬ê¸° í†µì¼ */
    font-weight: 400;
  }

  /* ê°œë³„ ì•„ì´ë””ë„ info-item ìŠ¤íƒ€ì¼ ìƒì† */
  #weather, #time, #battery {
    composes: info-item;
    /* ê°œë³„ ìŠ¤íƒ€ì¼ ëª¨ë‘ ì œê±° - í†µì¼ë¨ */
  }

  /* ë‚ ì”¨ ì„¤ëª… í…ìŠ¤íŠ¸ë„ ë™ì¼í•˜ê²Œ */
  .weather-desc {
    color: #ffffff;
    font-size: 13px;
    font-weight: 400;
  }

  /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
  #overlay::-webkit-scrollbar {
    display: none;
  }
</style>
</head>

<body>

<!-- ğŸ“Œ í•˜ë‹¨ ì˜¤ë²„ë ˆì´ -->
<div id="overlay">

  <!-- ì™¼ìª½: GPS + ìˆ˜ìµ -->
  <div class="left-section">
    <!-- GPS ì´ë™ê±°ë¦¬ ì„¹ì…˜ -->
    <div class="section">
      <span class="status-dot connecting"></span>
      <span id="distance">ì´ë™ê±°ë¦¬: 0.00 km</span>
    </div>

    <!-- ìˆ˜ìµ ë°ì´í„° -->
    <div class="revenue-wrapper">
      <div class="revenue-item">
        <span class="revenue-label">ì¼</span>
        <span class="revenue-value" id="daily-value">0</span>
      </div>
      <div class="revenue-item">
        <span class="revenue-label">ì›”</span>
        <span class="revenue-value" id="weekly-value">0</span>
      </div>
      <div class="revenue-item">
        <span class="revenue-label">ë…„</span>
        <span class="revenue-value" id="monthly-value">0</span>
      </div>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½: ë‚ ì”¨ + ì‹œê°„ + ë°°í„°ë¦¬ + ë¡œê³  -->
  <div class="right-section">
    <!-- ë‚ ì”¨ ì„¹ì…˜ - info-item í´ë˜ìŠ¤ ì¶”ê°€ -->
    <div class="info-item" id="weather">
      <span>ğŸŒ¡ï¸</span>
      <span>ë‚ ì”¨: --Â°C</span>
    </div>
    
    <!-- ì‹œê°„ ì„¹ì…˜ - info-item í´ë˜ìŠ¤ ì¶”ê°€ -->
    <div class="info-item" id="time">
      <span>ğŸ•</span>
      <span>ì‹œê°„: --:--</span>
    </div>
    
    <!-- ë°°í„°ë¦¬ ì„¹ì…˜ - info-item í´ë˜ìŠ¤ ì¶”ê°€ -->
    <div class="info-item" id="battery">
      <span>ğŸ”‹</span>
      <span>ë°°í„°ë¦¬: --%</span>
    </div>

    <!-- í”Œë«í¼ ë¡œê³  ì„¹ì…˜ -->
    <div class="section" style="gap: 2px;">
      <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%88%B2%EB%A1%9C%EA%B3%A0.png" alt="ìˆ²" title="ìˆ²" />
      <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%B9%98%EC%A7%80%EC%A7%81%EB%A1%9C%EA%B3%A0.png" alt="ì¹˜ì§€ì§" title="ì¹˜ì§€ì§" />
      <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%ED%8A%B8%EC%9C%84%EC%B9%98%EB%A1%9C%EA%B3%A0.png" alt="Twitch" title="Twitch" />
      <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%9C%A0%ED%8A%9C%EB%B8%8C%EB%A1%9C%EA%B3%A0.png" alt="YouTube" title="YouTube" />
    </div>
  </div>

</div>

<script>
/* =========================
    Firebase ì„¤ì •
========================= */
const firebaseConfig = {
    apiKey: "AIzaSyA5hMmN9QFgdFtaA5gicS_pj-blu_jJdvE",
    authDomain: "rider-bf48b.firebaseapp.com",
    databaseURL: "https://rider-bf48b-default-rtdb.firebaseio.com",
    projectId: "rider-bf48b",
    storageBucket: "rider-bf48b.firebasestorage.app",
    messagingSenderId: "1026929653322",
    appId: "1:1026929653322:web:b90541cccba5b4186198b3"
};

// Firebase ì´ˆê¸°í™”
let db;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    console.log('Firebase ì—°ê²° ì„±ê³µ');
} catch (error) {
    console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
}

/* =========================
    Firebase ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
========================= */
function loadRevenueData() {
    if (!db) {
        console.error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        return;
    }

    db.ref('overlayData').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            document.getElementById('daily-value').textContent = 
                data.daily ? formatRevenue(data.daily) : '0';
            document.getElementById('weekly-value').textContent = 
                data.weekly ? formatRevenue(data.weekly) : '0';
            document.getElementById('monthly-value').textContent = 
                data.monthly ? formatRevenue(data.monthly) : '0';
            
            console.log('ìˆ˜ìµ ë°ì´í„° ì—…ë°ì´íŠ¸:', data);
        }
    }, (error) => {
        console.error('Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    });
}

// ìˆ˜ìµ ë°ì´í„° í¬ë§·íŒ…
function formatRevenue(value) {
    const num = parseInt(value.toString().replace(/[^0-9]/g, ''));
    if (isNaN(num)) return value;
    return num.toLocaleString() + 'ì›';
}

/* =========================
    ê¸°ë³¸ ì„¤ì •
========================= */
const PULL_KEY = "zeoeyze9htbyx455";
const WEATHER_API = "3a4a39b054762e36581605681026ed35";

/* =========================
    ì´ë™ê±°ë¦¬ ê³„ì‚°
========================= */
let totalDistance = 0;
let previousLocation = null;
let lastUpdateTime = 0;
const GPS_TIMEOUT = 610000;

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function updateStatus(status) {
  const dot = document.querySelector('.status-dot');
  if (dot) {
    dot.className = 'status-dot';
    if (status) {
      dot.classList.add(status);
    }
  }
}

function resetDistance() {
  totalDistance = 0;
  previousLocation = null;
  console.log('ê±°ë¦¬ ì´ˆê¸°í™”ë¨');
  updateDistanceDisplay();
}

function updateDistanceDisplay() {
  const distanceEl = document.getElementById('distance');
  if (distanceEl) {
    distanceEl.textContent = 'ì´ë™ê±°ë¦¬: ' + totalDistance.toFixed(2) + ' km';
  }
}

/* =========================
    RealtimeIRL GPS ìˆ˜ì‹ 
========================= */
try {
  RealtimeIRL.forPullKey(PULL_KEY).addLocationListener((location) => {
    const now = Date.now();
    console.log('ìœ„ì¹˜ ìˆ˜ì‹ :', location);
    
    if (lastUpdateTime > 0 && (now - lastUpdateTime) > GPS_TIMEOUT) {
      console.log('âš ï¸ GPS ì‹ í˜¸ ëŠê¹€ ê°ì§€ - ê±°ë¦¬ ë¦¬ì…‹');
      resetDistance();
    }
    
    lastUpdateTime = now;
    
    if (location.latitude && location.longitude) {
      if (previousLocation) {
        const distance = calculateDistance(
          previousLocation.latitude, 
          previousLocation.longitude,
          location.latitude, 
          location.longitude
        );
        
        totalDistance += distance / 1000;
        console.log(`ì´ë™: ${distance.toFixed(2)}m, ì´: ${totalDistance.toFixed(2)}km`);
      }
      
      previousLocation = location;
      updateDistanceDisplay();
      updateStatus('');
    } else {
      console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ìœ„ì¹˜ ë°ì´í„°');
      updateStatus('error');
    }
  });

  console.log('RealtimeIRL ì—°ê²° ì‹œì‘');
  updateStatus('connecting');

} catch (error) {
  console.error('RealtimeIRL ì˜¤ë¥˜:', error);
  document.getElementById('distance').textContent = 'ì´ë™ê±°ë¦¬: ì—°ê²° ì‹¤íŒ¨';
  updateStatus('error');
}

/* =========================
    GPS ì‹ í˜¸ ì²´í¬
========================= */
setInterval(() => {
  if (lastUpdateTime > 0) {
    const timeSinceLastUpdate = Date.now() - lastUpdateTime;
    
    if (timeSinceLastUpdate > GPS_TIMEOUT) {
      console.log('âš ï¸ GPS ì‹ í˜¸ ì—†ìŒ - ê±°ë¦¬ ë¦¬ì…‹');
      resetDistance();
      lastUpdateTime = 0;
      updateStatus('error');
      
      const distanceEl = document.getElementById('distance');
      if (distanceEl) {
        distanceEl.textContent = 'ì´ë™ê±°ë¦¬: GPS ì‹ í˜¸ ì—†ìŒ';
      }
    }
  }
}, 1000);

/* =========================
    ë‚ ì”¨ ì—…ë°ì´íŠ¸ (í†µì¼ëœ ìŠ¤íƒ€ì¼ ìœ ì§€)
========================= */
async function updateWeather() {
  const url =
    "https://api.openweathermap.org/data/2.5/weather?q=Sejong,KR&appid=" +
    WEATHER_API +
    "&units=metric&lang=kr";

  try {
    const res = await fetch(url);
    const data = await res.json();

    const temp = Math.round(data.main.temp);
    const description = data.weather[0]?.description || '';
    
    // info-item êµ¬ì¡° ìœ ì§€í•˜ë©´ì„œ ë‚ ì”¨ ì„¤ëª… ì¶”ê°€
    const weatherElement = document.getElementById("weather");
    if (weatherElement) {
      weatherElement.innerHTML = `<span>ğŸŒ¡ï¸</span> <span>ë‚ ì”¨: ${temp}Â°C ${description}</span>`;
    }
  } catch (e) {
    console.error('ë‚ ì”¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
    const weatherElement = document.getElementById("weather");
    if (weatherElement) {
      weatherElement.innerHTML = `<span>ğŸŒ¡ï¸</span> <span>ë‚ ì”¨: --Â°C</span>`;
    }
  }
}

updateWeather();
setInterval(updateWeather, 600000);

/* =========================
    ì‹œê°„ ì—…ë°ì´íŠ¸ (í†µì¼ëœ ìŠ¤íƒ€ì¼ ìœ ì§€)
========================= */
function updateTime() {
  const now = new Date();
  let hours = now.getHours();
  const minutes = now.getMinutes().toString().padStart(2, "0");
  const ampm = hours >= 12 ? "ì˜¤í›„" : "ì˜¤ì „";
  hours = hours % 12 || 12;

  const timeElement = document.getElementById("time");
  if (timeElement) {
    timeElement.innerHTML = `<span>ğŸ•</span> <span>ì‹œê°„: ${ampm} ${hours}:${minutes}</span>`;
  }
}

updateTime();
setInterval(updateTime, 1000);

/* =========================
    ë°°í„°ë¦¬ ì—…ë°ì´íŠ¸ (í†µì¼ëœ ìŠ¤íƒ€ì¼ ìœ ì§€)
========================= */
if (navigator.getBattery) {
  navigator.getBattery().then((battery) => {
    function updateBattery() {
      const level = Math.round(battery.level * 100);
      const charging = battery.charging ? 'âš¡' : 'ğŸ”‹';
      const batteryElement = document.getElementById("battery");
      if (batteryElement) {
        batteryElement.innerHTML = `<span>${charging}</span> <span>ë°°í„°ë¦¬: ${level}%</span>`;
      }
    }
    battery.addEventListener("levelchange", updateBattery);
    battery.addEventListener("chargingchange", updateBattery);
    updateBattery();
  });
} else {
  const batteryElement = document.getElementById("battery");
  if (batteryElement) {
    batteryElement.innerHTML = `<span>ğŸ”‹</span> <span>ë°°í„°ë¦¬: N/A</span>`;
  }
}

/* =========================
    Firebase ë°ì´í„° ë¡œë“œ
========================= */
setTimeout(() => {
  loadRevenueData();
}, 1000);

console.log('í”„ë­í¬ ì˜¤ë²„ë ˆì´ í†µí•© ì™„ë£Œ (ë‚ ì”¨/ì‹œê°„/ë°°í„°ë¦¬ í°íŠ¸ í†µì¼)');
</script>

</body>
</html>
