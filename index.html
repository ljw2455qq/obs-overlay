<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>í”„ë­í¬ ì˜¤ë²„ë ˆì´ (ì§€ë„ ì—†ìŒ)</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: "Pretendard", sans-serif;
        color: #fff;
        background: transparent;
      }

      /* í•˜ë‹¨ ì •ë³´ë°” */
      #overlay {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: 38px;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        gap: 25px;
        padding: 0 15px;
      }

      .section {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .icon {
        height: 20px;
      }
    </style>
  </head>

  <body>
    <!-- í•˜ë‹¨ ì •ë³´ë°” -->
    <div id="overlay">
      <div class="section" id="distance">ì´ë™ê±°ë¦¬: 0.0 km</div>
      <div class="section" id="weather">ë‚ ì”¨: --Â°C</div>
      <div class="section" id="time">ì‹œê°„: --:--</div>
      <div class="section" id="battery">ë°°í„°ë¦¬: --%</div>
      <div class="section" id="signal">ì‹ í˜¸: ğŸŸ¢</div>

      <div class="section">
        <img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/3/3f/Twitch_logo_2019.svg" />
        <img class="icon" src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" />
        <img class="icon" src="https://cdn-icons-png.flaticon.com/512/3670/3670157.png" />
        <img class="icon" src="https://cdn-icons-png.flaticon.com/512/5968/5968764.png" />
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@rtirl/api@latest/lib/index.min.js"></script>

<script>
const PULL_KEY = "zeoeyze9htbyx455";
const WEATHER_API = "3a4a39b054762e36581605681026ed35";

/* ì´ë™ê±°ë¦¬ */
let prevLocation = null;
let totalDistance = 0;

/* GPS ì‹ í˜¸ ê°ì§€ */
let gpsLost = false;
let lastTimestamp = 0;
let lastLat = null;
let lastLon = null;
let stillCount = 0; // ì´ë™ ì—†ìŒ ì¹´ìš´íŠ¸

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = ((lat2 - lat1) * Math.PI) / 180;
  const dLon = ((lon2 - lon1) * Math.PI) / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos((lat1 * Math.PI) / 180) *
      Math.cos((lat2 * Math.PI) / 180) *
      Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

RealtimeIRL.forPullKey(PULL_KEY).addLocationListener((loc) => {
  const { latitude, longitude, speed, accuracy, timestamp } = loc;

  /* =====================
      GPS OFF ê°ì§€ ì¡°ê±´
     ===================== */

  let gpsShouldBeLost = false;

  // 1) ì •í™•ë„ê°€ 100m ì´ìƒì´ë©´ GPSê°€ êº¼ì¡Œê±°ë‚˜ ì‹ í˜¸ê°€ ë§¤ìš° ë‚˜ì¨
  if (accuracy > 100) gpsShouldBeLost = true;

  // 2) timestamp ë³€í™” ì—†ìŒ â†’ ìœ„ì¹˜ê°’ì´ ê°±ì‹ ë˜ì§€ ì•ŠìŒ
  if (timestamp === lastTimestamp) gpsShouldBeLost = true;

  // 3) 5ì´ˆ ë™ì•ˆ speed 0 + ìœ„ì¹˜ ë³€í™” ê±°ì˜ ì—†ìœ¼ë©´ GPS OFF ê°€ëŠ¥ì„± ë†’ìŒ
  if (lastLat !== null && lastLon !== null) {
    const moved = haversine(lastLat, lastLon, latitude, longitude);
    if (moved < 0.005 && speed === 0) {
      stillCount++;
      if (stillCount >= 5) gpsShouldBeLost = true;
    } else {
      stillCount = 0;
    }
  }

  /* =====================
      GPS OFF â†’ ON ë³µêµ¬
     ===================== */
  if (gpsLost && !gpsShouldBeLost) {
    totalDistance = 0;
    prevLocation = null;

    document.getElementById("distance").innerText =
      "ì´ë™ê±°ë¦¬: 0.0 km";
    document.getElementById("signal").innerText = "ì‹ í˜¸: ğŸŸ¢ (ë³µêµ¬)";
  }

  /* GPS ìƒíƒœ ì—…ë°ì´íŠ¸ */
  gpsLost = gpsShouldBeLost;

  if (gpsLost) {
    document.getElementById("signal").innerText = "ì‹ í˜¸: ğŸ”´ (GPS OFF)";
    lastTimestamp = timestamp;
    lastLat = latitude;
    lastLon = longitude;
    return; // ê±°ë¦¬ ê³„ì‚° ì¤‘ë‹¨
  } else {
    document.getElementById("signal").innerText = "ì‹ í˜¸: ğŸŸ¢";
  }

  /* =====================
       ê±°ë¦¬ ëˆ„ì 
     ===================== */
  if (prevLocation) {
    const d = haversine(
      prevLocation.latitude,
      prevLocation.longitude,
      latitude,
      longitude
    );

    // ê¸‰ë°œì§„ íŠ€ëŠ” ê°’ ì œì™¸
    if (d < 0.5) totalDistance += d;
  }

  prevLocation = { latitude, longitude };
  lastLat = latitude;
  lastLon = longitude;
  lastTimestamp = timestamp;

  document.getElementById("distance").innerText =
    "ì´ë™ê±°ë¦¬: " + totalDistance.toFixed(1) + " km";
});
</script>


      /* ===============================
          ë‚ ì”¨ (ì„¸ì¢…)
      =============================== */
      async function updateWeather() {
        try {
          const url =
            "https://api.openweathermap.org/data/2.5/weather?q=Sejong,KR&appid=" +
            WEATHER_API +
            "&units=metric&lang=kr";

          const res = await fetch(url);
          const data = await res.json();
          document.getElementById("weather").innerText =
            "ë‚ ì”¨: " + Math.round(data.main.temp) + "Â°C";
        } catch (e) {
          document.getElementById("weather").innerText = "ë‚ ì”¨: --Â°C";
        }
      }
      updateWeather();
      setInterval(updateWeather, 600000);

      /* ===============================
          ì‹œê°„ (ì˜¤ì „/ì˜¤í›„)
      =============================== */
      function updateTime() {
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, "0");

        const ampm = hours >= 12 ? "ì˜¤í›„" : "ì˜¤ì „";
        hours = hours % 12 || 12;

        document.getElementById("time").innerText =
          "ì‹œê°„: " + ampm + " " + hours + ":" + minutes;
      }
      setInterval(updateTime, 1000);
      updateTime();

      /* ===============================
          ë°°í„°ë¦¬ ìƒíƒœ
      =============================== */
      navigator.getBattery?.().then((battery) => {
        function updateBattery() {
          document.getElementById("battery").innerText =
            "ë°°í„°ë¦¬: " + Math.round(battery.level * 100) + "%";
        }
        battery.addEventListener("levelchange", updateBattery);
        updateBattery();
      });
    </script>
  </body>
</html>
