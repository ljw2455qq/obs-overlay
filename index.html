<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>í”„ë­í¬ ì˜¤ë²„ë ˆì´</title>
<script src="https://cdn.jsdelivr.net/npm/@rtirl/api"></script>

<style>
  body {
    margin: 0;
    background: transparent;
    color: white;
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  }

  /* ì „ì²´ ì˜¤ë²„ë ˆì´ */
  #overlay {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    padding: 6px 12px;
    border-radius: 30px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    font-size: 14px;
    z-index: 9999;
  }

  /* GPS ê±°ë¦¬ */
  #distance {
    color: #7df9ff;
    font-weight: 700;
    text-shadow: 0 0 8px rgba(125, 249, 255, 0.5);
    margin-right: 2px;
  }

  /* ë‚ ì”¨, ì‹œê°„ */
  #weather, #time {
    display: flex;
    align-items: center;
    gap: 2px;
  }

  /* ë°°í„°ë¦¬ ì»¨í…Œì´ë„ˆ */
  .battery-container {
    display: flex;
    align-items: center;
    gap: 3px;
    position: relative;
  }

  /* ë°°í„°ë¦¬ ì•„ì´ì½˜ - ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
  #batteryIcon {
    width: 24px;
    height: 12px;
    border: 1.5px solid rgba(255, 255, 255, 0.9);
    border-radius: 3px;
    position: relative;
    background: rgba(0, 0, 0, 0.3);
  }

  /* ë°°í„°ë¦¬ ì”ëŸ‰ - 10% ë‹¨ìœ„ ìƒ‰ìƒ */
  #batteryFill {
    height: 100%;
    width: 0%;
    transition: width 0.3s ease, background 0.3s ease;
    border-radius: 1px;
  }

  /* ë°°í„°ë¦¬ ì”ëŸ‰ ìƒ‰ìƒ í´ë˜ìŠ¤ */
  #batteryFill.level-100 { background: #00ff00; box-shadow: 0 0 8px #00ff00; } /* 100% - í˜•ê´‘ì´ˆë¡ */
  #batteryFill.level-90 { background: #33ff00; box-shadow: 0 0 8px #33ff00; } /* 90% - ì—°ë‘ */
  #batteryFill.level-80 { background: #66ff00; box-shadow: 0 0 8px #66ff00; } /* 80% - ë°ì€ì—°ë‘ */
  #batteryFill.level-70 { background: #99ff00; box-shadow: 0 0 8px #99ff00; } /* 70% - ë…¸ë€ì—°ë‘ */
  #batteryFill.level-60 { background: #ccff00; box-shadow: 0 0 8px #ccff00; } /* 60% - ì—°ë‘ë…¸ë‘ */
  #batteryFill.level-50 { background: #ffff00; box-shadow: 0 0 8px #ffff00; } /* 50% - ë…¸ë‘ */
  #batteryFill.level-40 { background: #ffcc00; box-shadow: 0 0 8px #ffcc00; } /* 40% - ê¸ˆìƒ‰ */
  #batteryFill.level-30 { background: #ff9900; box-shadow: 0 0 8px #ff9900; } /* 30% - ì£¼í™© */
  #batteryFill.level-20 { background: #ff6600; box-shadow: 0 0 8px #ff6600; } /* 20% - ì§„í•œì£¼í™© */
  #batteryFill.level-10 { background: #ff3300; box-shadow: 0 0 8px #ff3300; } /* 10% - ì£¼í™ */
  #batteryFill.level-0 { background: #ff0000; box-shadow: 0 0 8px #ff0000; } /* 0% - ë¹¨ê°• */

  /* ì¶©ì „ ì¤‘ ë²ˆê°œ í‘œì‹œ - ì •ì¤‘ì•™ */
  #batteryBolt {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 16px;
    font-weight: bold;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.9), 0 0 20px rgba(255, 215, 0, 0.5);
    display: none;
    pointer-events: none;
    line-height: 1;
    z-index: 10;
    animation: boltPulse 1s infinite;
  }

  /* ë°°í„°ë¦¬ ëšœê»‘ */
  #batteryCap {
    position: absolute;
    right: -4px;
    top: 2.5px;
    width: 2px;
    height: 5px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 1px;
  }

  /* ë°°í„°ë¦¬ í…ìŠ¤íŠ¸ */
  #batteryText {
    min-width: 35px;
    font-weight: 500;
    font-size: 13px;
  }

  /* ë¡œê³  ì»¨í…Œì´ë„ˆ */
  .logo-container {
    display: flex;
    align-items: center;
    gap: 3px;
    padding-left: 4px;
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    margin-left: 2px;
  }

  /* ë¡œê³  ì•„ì´ì½˜ */
  .icon {
    height: 16px;
    width: auto;
    opacity: 0.8;
    transition: all 0.2s ease;
    filter: brightness(0.9);
  }

  .icon:hover {
    opacity: 1;
    transform: scale(1.1);
    filter: brightness(1.2);
  }

  /* íˆ´íŒ */
  [data-tooltip] {
    position: relative;
    cursor: help;
  }

  [data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 30px;
    right: 0;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 10000;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  /* ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes boltPulse {
    0%, 100% { 
      opacity: 1; 
      transform: translate(-50%, -50%) scale(1);
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.9), 0 0 20px rgba(255, 215, 0, 0.5);
    }
    50% { 
      opacity: 0.8; 
      transform: translate(-50%, -50%) scale(1.2);
      text-shadow: 0 0 15px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 215, 0, 0.8);
    }
  }

  /* ëª¨ë“  ìš”ì†Œì˜ ê¸°ë³¸ ì—¬ë°± ì œê±° */
  div, span {
    margin: 0;
    padding: 0;
  }
</style>
</head>
<body>

<div id="overlay">

  <!-- GPS ê±°ë¦¬ -->
  <div id="distance" data-tooltip="ì˜¤ëŠ˜ ì´ë™ ê±°ë¦¬">
    0.00 km
  </div>

  <!-- ë‚ ì”¨ -->
  <div id="weather" data-tooltip="í˜„ì¬ ë‚ ì”¨">
    ğŸŒ¡ï¸ --
  </div>

  <!-- ì‹œê°„ -->
  <div id="time" data-tooltip="í˜„ì¬ ì‹œê°„">
    ğŸ• --
  </div>

  <!-- ë°°í„°ë¦¬ - ê¸°ì¡´ ìŠ¤íƒ€ì¼ + 10% ë‹¨ìœ„ ìƒ‰ìƒ -->
  <div class="battery-container" data-tooltip="ë°°í„°ë¦¬ ì”ëŸ‰">
    <div id="batteryIcon">
      <div id="batteryFill"></div>
      <div id="batteryBolt">âš¡</div>
      <div id="batteryCap"></div>
    </div>
    <div id="batteryText">--%</div>
  </div>

  <!-- ë¡œê³  -->
  <div class="logo-container">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%88%B2%EB%A1%9C%EA%B3%A0.png" alt="ìˆ²" title="ìˆ²">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%B9%98%EC%A7%80%EC%A7%81%EB%A1%9C%EA%B3%A0.png" alt="ì¹˜ì§€ì§" title="ì¹˜ì§€ì§">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%ED%8A%B8%EC%9C%84%EC%B9%98%EB%A1%9C%EA%B3%A0.png" alt="Twitch" title="Twitch">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%9C%A0%ED%8A%9C%EB%B8%8C%EB%A1%9C%EA%B3%A0.png" alt="YouTube" title="YouTube">
  </div>

</div>

<script type="module">
/* ======================
   Firebase ì„¤ì •
====================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyA5hMmN9QFgdFtaA5gicS_pj-blu_jJdvE",
  authDomain: "rider-bf48b.firebaseapp.com",
  databaseURL: "https://rider-bf48b-default-rtdb.firebaseio.com",
  projectId: "rider-bf48b",
  storageBucket: "rider-bf48b.firebasestorage.app",
  messagingSenderId: "1026929653322",
  appId: "1:1026929653322:web:b90541cccba5b4186198b3"
};

// Firebase ì´ˆê¸°í™”
let db;
try {
  const app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  console.log('ğŸ”¥ Firebase ì—°ê²° ì„±ê³µ');
} catch (error) {
  console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
}

/* ======================
   10% ë‹¨ìœ„ ìƒ‰ìƒ ë°˜í™˜ í•¨ìˆ˜
====================== */
function getBatteryLevelClass(level) {
  // ë ˆë²¨ì„ 10ë‹¨ìœ„ë¡œ ë‚´ë¦¼ (0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)
  const roundedLevel = Math.floor(level / 10) * 10;
  
  switch(roundedLevel) {
    case 100: return 'level-100';
    case 90: return 'level-90';
    case 80: return 'level-80';
    case 70: return 'level-70';
    case 60: return 'level-60';
    case 50: return 'level-50';
    case 40: return 'level-40';
    case 30: return 'level-30';
    case 20: return 'level-20';
    case 10: return 'level-10';
    default: return 'level-0';
  }
}

/* ======================
   ë°°í„°ë¦¬ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
====================== */
function updateBattery(level, charging) {
  const batteryText = document.getElementById('batteryText');
  const batteryFill = document.getElementById('batteryFill');
  const batteryBolt = document.getElementById('batteryBolt');
  
  level = Math.min(100, Math.max(0, level));
  
  // ë°°í„°ë¦¬ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  batteryText.innerText = level + '%';
  
  // ë°°í„°ë¦¬ ì”ëŸ‰ í‘œì‹œ (ë„ˆë¹„)
  batteryFill.style.width = level + '%';
  
  // ë°°í„°ë¦¬ ìƒ‰ìƒ í´ë˜ìŠ¤ ì ìš© (10% ë‹¨ìœ„)
  const levelClass = getBatteryLevelClass(level);
  batteryFill.className = levelClass; // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±° í›„ ìƒˆ í´ë˜ìŠ¤ ì ìš©
  
  // ì¶©ì „ ì¤‘ì¼ ë•Œ ë²ˆê°œ í‘œì‹œ
  if (charging) {
    batteryBolt.style.display = 'block';
  } else {
    batteryBolt.style.display = 'none';
  }
}

// ë°°í„°ë¦¬ ë°ì´í„° ìˆ˜ì‹ 
if (db) {
  onValue(ref(db, "battery"), (snapshot) => {
    if (!snapshot.exists()) return;
    const data = snapshot.val();
    if (data && typeof data.level === 'number') {
      updateBattery(data.level, data.charging || false);
    }
  }, (error) => {
    console.error('âŒ ë°°í„°ë¦¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„°
    setInterval(() => {
      const dummyLevel = Math.floor(Math.random() * 101);
      updateBattery(dummyLevel, Math.random() > 0.7);
    }, 3000);
  });
} else {
  // Firebase ì—†ì„ ë•Œ í…ŒìŠ¤íŠ¸ìš©
  console.log('âš ï¸ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë”ë¯¸ ë°°í„°ë¦¬ ë°ì´í„° ì‚¬ìš©');
  setInterval(() => {
    const dummyLevel = Math.floor(Math.random() * 101);
    updateBattery(dummyLevel, Math.random() > 0.7);
  }, 3000);
}

/* ======================
    GPS ê±°ë¦¬ ê³„ì‚°
====================== */
let totalDistance = 0;
let previousLocation = null;
let lastUpdateTime = 0;

// 6ì‹œê°„ = 6(ì‹œê°„) * 60(ë¶„) * 60(ì´ˆ) * 1000(ë°€ë¦¬ì´ˆ)
const GPS_TIMEOUT = 21600000;

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Î”Ï†/2) ** 2 +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î»/2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function updateDistanceDisplay() {
  const distanceEl = document.getElementById('distance');
  if (distanceEl) {
    distanceEl.innerText = totalDistance.toFixed(2) + ' km';
  }
}

setInterval(() => {
  if (lastUpdateTime > 0 && Date.now() - lastUpdateTime > GPS_TIMEOUT) {
    console.log('âš ï¸ GPS ì‹ í˜¸ ì—†ìŒ');
    document.getElementById('distance').innerHTML = 'â¸ï¸ ì‹ í˜¸ì—†ìŒ';
  }
}, 1000);

try {
  RealtimeIRL.forPullKey("zeoeyze9htbyx455").addLocationListener((location) => {
    const now = Date.now();
    lastUpdateTime = now;
    
    if (location.latitude && location.longitude) {
      if (previousLocation) {
        const distance = calculateDistance(
          previousLocation.latitude,
          previousLocation.longitude,
          location.latitude,
          location.longitude
        );
        
        totalDistance += distance / 1000;
      }
      previousLocation = location;
      updateDistanceDisplay();
    }
  });
  console.log('ğŸ“ GPS ì—°ê²° ì‹œì‘');
} catch (error) {
  console.error('âŒ GPS ì˜¤ë¥˜:', error);
  document.getElementById('distance').innerText = 'GPS ì˜¤ë¥˜';
}

/* ======================
   ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
====================== */
window.addEventListener('beforeunload', () => {
  localStorage.setItem('totalDistance', totalDistance.toString());
});

const savedDistance = localStorage.getItem('totalDistance');
if (savedDistance) {
  totalDistance = parseFloat(savedDistance);
  updateDistanceDisplay();
}

/* ======================
   ì‹œê°„ ì—…ë°ì´íŠ¸
====================== */
function updateTime() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('ko-KR', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: true
  });
  document.getElementById('time').innerHTML = `ğŸ• ${timeStr}`;
}
updateTime();
setInterval(updateTime, 1000);

/* ======================
   ë‚ ì”¨ ì—…ë°ì´íŠ¸
====================== */
const WEATHER_API = "3a4a39b054762e36581605681026ed35";
const CITY = "Sejong";

async function updateWeather() {
  try {
    const response = await fetch(
      `https://api.openweathermap.org/data/2.5/weather?q=${CITY}&appid=${WEATHER_API}&units=metric&lang=kr`
    );
    
    if (!response.ok) throw new Error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ');
    
    const data = await response.json();
    const temp = Math.round(data.main.temp);
    const weatherEmoji = getWeatherEmoji(data.weather[0].icon);
    
    document.getElementById('weather').innerHTML = 
      `${weatherEmoji} ${temp}Â°C`;
      
  } catch (error) {
    console.error('âŒ ë‚ ì”¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    document.getElementById('weather').innerHTML = 'ğŸŒ¡ï¸ --Â°C';
  }
}

function getWeatherEmoji(iconCode) {
  const map = {
    '01d': 'â˜€ï¸', '01n': 'ğŸŒ™',
    '02d': 'â›…', '02n': 'â˜ï¸',
    '03d': 'â˜ï¸', '03n': 'â˜ï¸',
    '04d': 'â˜ï¸', '04n': 'â˜ï¸',
    '09d': 'ğŸŒ§ï¸', '09n': 'ğŸŒ§ï¸',
    '10d': 'ğŸŒ¦ï¸', '10n': 'ğŸŒ§ï¸',
    '11d': 'â›ˆï¸', '11n': 'â›ˆï¸',
    '13d': 'â„ï¸', '13n': 'â„ï¸',
    '50d': 'ğŸŒ«ï¸', '50n': 'ğŸŒ«ï¸'
  };
  return map[iconCode] || 'ğŸŒ¡ï¸';
}

updateWeather();
setInterval(updateWeather, 600000);

console.log('âœ… í”„ë­í¬ ì˜¤ë²„ë ˆì´ ë¡œë“œ ì™„ë£Œ (ê¸°ì¡´ ë¡œê³  + 10% ë‹¨ìœ„ ìƒ‰ìƒ)');
</script>

</body>
</html>
