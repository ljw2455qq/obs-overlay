<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>í”„ë­í¬ ì˜¤ë²„ë ˆì´ (GPS + ìˆ˜ìµ)</title>
<script src="https://cdn.jsdelivr.net/npm/@rtirl/api"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: transparent;
    color: white;
  }

  /* í•˜ë‹¨ë°” */
  #overlay {
    position: fixed;
    bottom: 0;
    width: 100%;
    min-height: 38px;
    background: rgba(0, 0, 0, 0.70);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    font-size: 15px;
    padding: 8px 15px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
    flex-wrap: wrap;
  }

  .section {
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  .icon {
    height: 20px;
    opacity: 0.9;
    transition: opacity 0.3s ease;
  }

  .icon:hover {
    opacity: 1;
  }

  /* ê±°ë¦¬ ê°•ì¡° */
  #distance {
    font-weight: 600;
    color: #00ff88;
    text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
  }

  /* ìˆ˜ìµ ë°ì´í„° ìŠ¤íƒ€ì¼ */
  .revenue-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 4px 10px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .revenue-label {
    font-size: 12px;
    opacity: 0.8;
  }

  .revenue-value {
    font-weight: 700;
    color: #ffd700;
  }

  #daily-value { color: #4CAF50; }
  #weekly-value { color: #2196F3; }
  #monthly-value { color: #FF9800; }

  /* ìƒíƒœ í‘œì‹œ */
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4CAF50;
    display: inline-block;
    margin-right: 4px;
    animation: pulse 2s infinite;
  }

  .status-dot.connecting {
    background: #FF9800;
  }

  .status-dot.error {
    background: #F44336;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  /* ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    #overlay {
      gap: 12px;
      font-size: 13px;
      padding: 6px 10px;
    }
    .icon {
      height: 16px;
    }
    .revenue-item {
      padding: 2px 6px;
    }
  }
</style>
</head>

<body>

<!-- ğŸ“Œ í•˜ë‹¨ ì˜¤ë²„ë ˆì´ -->
<div id="overlay">

  <!-- GPS ì´ë™ê±°ë¦¬ ì„¹ì…˜ -->
  <div class="section" id="distance-section">
    <span class="status-dot connecting"></span>
    <span id="distance">ì´ë™ê±°ë¦¬: 0.00 km</span>
  </div>

  <!-- ìˆ˜ìµ ë°ì´í„° ì„¹ì…˜ (Firebase) -->
  <div class="section revenue-item">
    <span class="revenue-label">ì¼</span>
    <span class="revenue-value" id="daily-value">0</span>
  </div>
  <div class="section revenue-item">
    <span class="revenue-label">ì›”</span>
    <span class="revenue-value" id="weekly-value">0</span>
  </div>
  <div class="section revenue-item">
    <span class="revenue-label">ë…„</span>
    <span class="revenue-value" id="monthly-value">0</span>
  </div>

  <!-- ë‚ ì”¨ ì„¹ì…˜ -->
  <div class="section" id="weather">ğŸŒ¡ï¸ ë‚ ì”¨: --Â°C</div>
  
  <!-- ì‹œê°„ ì„¹ì…˜ -->
  <div class="section" id="time">ğŸ• ì‹œê°„: --:--</div>
  
  <!-- ë°°í„°ë¦¬ ì„¹ì…˜ -->
  <div class="section" id="battery">ğŸ”‹ ë°°í„°ë¦¬: --%</div>

  <!-- í”Œë«í¼ ë¡œê³  ì„¹ì…˜ -->
  <div class="section">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%88%B2%EB%A1%9C%EA%B3%A0.png" alt="ìˆ²" title="ìˆ²" />
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%B9%98%EC%A7%80%EC%A7%81%EB%A1%9C%EA%B3%A0.png" alt="ì¹˜ì§€ì§" title="ì¹˜ì§€ì§" />
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%ED%8A%B8%EC%9C%84%EC%B9%98%EB%A1%9C%EA%B3%A0.png" alt="Twitch" title="Twitch" />
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%9C%A0%ED%8A%9C%EB%B8%8C%EB%A1%9C%EA%B3%A0.png" alt="YouTube" title="YouTube" />
  </div>
</div>

<script>
/* =========================
    Firebase ì„¤ì •
========================= */
// Firebase êµ¬ì„± ì •ë³´ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
const firebaseConfig = {
    apiKey: "AIzaSyA5hMmN9QFgdFtaA5gicS_pj-blu_jJdvE",
    authDomain: "rider-bf48b.firebaseapp.com",
    databaseURL: "https://rider-bf48b-default-rtdb.firebaseio.com",
    projectId: "rider-bf48b",
    storageBucket: "rider-bf48b.firebasestorage.app",
    messagingSenderId: "1026929653322",
    appId: "1:1026929653322:web:b90541cccba5b4186198b3"
};

// Firebase ì´ˆê¸°í™”
let db;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    console.log('Firebase ì—°ê²° ì„±ê³µ');
} catch (error) {
    console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
}

/* =========================
    Firebase ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
========================= */
function loadRevenueData() {
    if (!db) {
        console.error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        return;
    }

    db.ref('overlayData').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            document.getElementById('daily-value').textContent = 
                data.daily ? formatRevenue(data.daily) : '0';
            document.getElementById('weekly-value').textContent = 
                data.weekly ? formatRevenue(data.weekly) : '0';
            document.getElementById('monthly-value').textContent = 
                data.monthly ? formatRevenue(data.monthly) : '0';
            
            console.log('ìˆ˜ìµ ë°ì´í„° ì—…ë°ì´íŠ¸:', data);
        }
    }, (error) => {
        console.error('Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    });
}

// ìˆ˜ìµ ë°ì´í„° í¬ë§·íŒ… (ì›í™” í‘œì‹œ)
function formatRevenue(value) {
    // ìˆ«ìë§Œ ì¶”ì¶œ
    const num = parseInt(value.toString().replace(/[^0-9]/g, ''));
    if (isNaN(num)) return value;
    
    // ì²œ ë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
    return num.toLocaleString() + 'ì›';
}

/* =========================
    ê¸°ë³¸ ì„¤ì •
========================= */
const PULL_KEY = "zeoeyze9htbyx455";
const WEATHER_API = "3a4a39b054762e36581605681026ed35";

/* =========================
    ì´ë™ê±°ë¦¬ ê³„ì‚°
========================= */
let totalDistance = 0;
let previousLocation = null;
let lastUpdateTime = 0;
const GPS_TIMEOUT = 610000; // 610ì´ˆ ë™ì•ˆ ì‹ í˜¸ ì—†ìœ¼ë©´ ë¦¬ì…‹

// Haversine ê³µì‹
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* =========================
    ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
========================= */
function updateStatus(status) {
  const dot = document.querySelector('.status-dot');
  if (dot) {
    dot.className = 'status-dot';
    if (status) {
      dot.classList.add(status);
    }
  }
}

/* =========================
    ê±°ë¦¬ ì´ˆê¸°í™” í•¨ìˆ˜
========================= */
function resetDistance() {
  totalDistance = 0;
  previousLocation = null;
  console.log('ê±°ë¦¬ ì´ˆê¸°í™”ë¨');
  updateDistanceDisplay();
}

/* =========================
    ê±°ë¦¬ í‘œì‹œ ì—…ë°ì´íŠ¸
========================= */
function updateDistanceDisplay() {
  const distanceEl = document.getElementById('distance');
  if (distanceEl) {
    distanceEl.innerHTML = 'ì´ë™ê±°ë¦¬: ' + totalDistance.toFixed(2) + ' km';
  }
}

/* =========================
    RealtimeIRL GPS ìˆ˜ì‹ 
========================= */
try {
  RealtimeIRL.forPullKey(PULL_KEY).addLocationListener((location) => {
    const now = Date.now();
    console.log('ìœ„ì¹˜ ìˆ˜ì‹ :', location);
    
    // GPS ì‹ í˜¸ê°€ 10ì´ˆ ì´ìƒ ëŠê²¼ë‹¤ê°€ ë‹¤ì‹œ ë“¤ì–´ì˜¤ë©´ ë¦¬ì…‹
    if (lastUpdateTime > 0 && (now - lastUpdateTime) > GPS_TIMEOUT) {
      console.log('âš ï¸ GPS ì‹ í˜¸ ëŠê¹€ ê°ì§€ - ê±°ë¦¬ ë¦¬ì…‹');
      resetDistance();
    }
    
    lastUpdateTime = now;
    
    if (location.latitude && location.longitude) {
      // ì´ì „ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ê±°ë¦¬ ê³„ì‚°
      if (previousLocation) {
        const distance = calculateDistance(
          previousLocation.latitude, 
          previousLocation.longitude,
          location.latitude, 
          location.longitude
        );
        
        // ë¯¸í„°ë¥¼ í‚¬ë¡œë¯¸í„°ë¡œ ë³€í™˜
        totalDistance += distance / 1000;
        
        console.log(`ì´ë™: ${distance.toFixed(2)}m, ì´: ${totalDistance.toFixed(2)}km`);
      }
      
      // í˜„ì¬ ìœ„ì¹˜ ì €ì¥
      previousLocation = location;
      
      // ê±°ë¦¬ í‘œì‹œ ì—…ë°ì´íŠ¸
      updateDistanceDisplay();
      
      // ìƒíƒœ ì—…ë°ì´íŠ¸
      updateStatus('');
    } else {
      console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ìœ„ì¹˜ ë°ì´í„°');
      updateStatus('error');
    }
  });

  console.log('RealtimeIRL ì—°ê²° ì‹œì‘');
  updateStatus('connecting');

} catch (error) {
  console.error('RealtimeIRL ì˜¤ë¥˜:', error);
  document.getElementById('distance').innerHTML = 'ì´ë™ê±°ë¦¬: ì—°ê²° ì‹¤íŒ¨';
  updateStatus('error');
}

/* =========================
    GPS ì‹ í˜¸ ì²´í¬ (1ì´ˆë§ˆë‹¤)
========================= */
setInterval(() => {
  if (lastUpdateTime > 0) {
    const timeSinceLastUpdate = Date.now() - lastUpdateTime;
    
    if (timeSinceLastUpdate > GPS_TIMEOUT) {
      console.log('âš ï¸ GPS ì‹ í˜¸ ì—†ìŒ - ê±°ë¦¬ ë¦¬ì…‹');
      resetDistance();
      lastUpdateTime = 0;
      updateStatus('error');
      
      const distanceEl = document.getElementById('distance');
      if (distanceEl) {
        distanceEl.innerHTML = 'ì´ë™ê±°ë¦¬: GPS ì‹ í˜¸ ì—†ìŒ';
      }
    }
  }
}, 1000);

/* =========================
    ë‚ ì”¨ ì—…ë°ì´íŠ¸
========================= */
async function updateWeather() {
  const url =
    "https://api.openweathermap.org/data/2.5/weather?q=Sejong,KR&appid=" +
    WEATHER_API +
    "&units=metric&lang=kr";

  try {
    const res = await fetch(url);
    const data = await res.json();

    const temp = Math.round(data.main.temp);
    const description = data.weather[0]?.description || '';
    
    document.getElementById("weather").innerHTML =
      `ğŸŒ¡ï¸ ë‚ ì”¨: ${temp}Â°C ${description}`;
  } catch (e) {
    console.error('ë‚ ì”¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
    document.getElementById("weather").innerHTML = "ğŸŒ¡ï¸ ë‚ ì”¨: --Â°C";
  }
}

updateWeather();
setInterval(updateWeather, 600000); // 10ë¶„ë§ˆë‹¤

/* =========================
    ì‹œê°„ (ì˜¤ì „/ì˜¤í›„)
========================= */
function updateTime() {
  const now = new Date();
  let hours = now.getHours();
  const minutes = now.getMinutes().toString().padStart(2, "0");
  const ampm = hours >= 12 ? "ì˜¤í›„" : "ì˜¤ì „";
  hours = hours % 12 || 12;

  document.getElementById("time").innerHTML =
    "ğŸ• ì‹œê°„: " + ampm + " " + hours + ":" + minutes;
}

updateTime();
setInterval(updateTime, 1000);

/* =========================
    ë°°í„°ë¦¬
========================= */
if (navigator.getBattery) {
  navigator.getBattery().then((battery) => {
    function updateBattery() {
      const level = Math.round(battery.level * 100);
      const charging = battery.charging ? 'âš¡' : 'ğŸ”‹';
      document.getElementById("battery").innerHTML =
        charging + " ë°°í„°ë¦¬: " + level + "%";
    }
    battery.addEventListener("levelchange", updateBattery);
    battery.addEventListener("chargingchange", updateBattery);
    updateBattery();
  });
} else {
  document.getElementById("battery").innerHTML = "ğŸ”‹ ë°°í„°ë¦¬: N/A";
}

/* =========================
    Firebase ë°ì´í„° ë¡œë“œ ì‹œì‘
========================= */
// Firebaseê°€ ì´ˆê¸°í™”ë  ì‹œê°„ì„ ì£¼ê¸° ìœ„í•´ ì•½ê°„ ì§€ì—°
setTimeout(() => {
  loadRevenueData();
}, 1000);

/* =========================
    ë””ë²„ê¹… (5ì´ˆë§ˆë‹¤)
========================= */
setInterval(() => {
  const timeSinceUpdate = lastUpdateTime > 0 ? Math.floor((Date.now() - lastUpdateTime) / 1000) : 0;
  console.log(`[ìƒíƒœ] ì´ ê±°ë¦¬: ${totalDistance.toFixed(3)}km | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timeSinceUpdate}ì´ˆ ì „`);
}, 5000);

console.log('í”„ë­í¬ ì˜¤ë²„ë ˆì´ í†µí•© ì™„ë£Œ');
</script>

</body>
</html>