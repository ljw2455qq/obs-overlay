<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>í”„ë­í¬ ì˜¤ë²„ë ˆì´</title>
<script src="https://cdn.jsdelivr.net/npm/@rtirl/api"></script>

<style>
  body {
    margin: 0;
    background: transparent;
    color: white;
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  }

  /* ì „ì²´ ì˜¤ë²„ë ˆì´ */
  #overlay {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    padding: 8px 18px;
    border-radius: 30px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    font-size: 15px;
    z-index: 9999;
  }

  /* GPS ê±°ë¦¬ - ì—°í•œ í•˜ëŠ˜ìƒ‰ */
  #distance {
    color: #7df9ff;
    font-weight: 700;
    text-shadow: 0 0 8px rgba(125, 249, 255, 0.5);
    letter-spacing: 0.3px;
    min-width: 80px;
  }

  /* ë‚ ì”¨, ì‹œê°„ */
  #weather, #time {
    opacity: 0.95;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* ë°°í„°ë¦¬ ì»¨í…Œì´ë„ˆ */
  .battery-container {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ë°°í„°ë¦¬ ì•„ì´ì½˜ */
  #batteryIcon {
    width: 28px;
    height: 14px;
    border: 2px solid rgba(255, 255, 255, 0.9);
    border-radius: 3px;
    position: relative;
    background: rgba(0, 0, 0, 0.3);
  }

  /* ë°°í„°ë¦¬ ì”ëŸ‰ */
  #batteryFill {
    height: 100%;
    width: 0%;
    background: #00ff00;
    transition: width 0.3s ease, background 0.3s ease;
    border-radius: 1px;
  }

  /* ì¶©ì „ ì¤‘ ë²ˆê°œ í‘œì‹œ */
  #batteryBolt {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    color: #ffd700;
    text-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
    background: rgba(0, 0, 0, 0.3);
    border-radius: 2px;
  }

  /* ë°°í„°ë¦¬ ëšœê»‘ */
  #batteryCap {
    position: absolute;
    right: -5px;
    top: 3px;
    width: 3px;
    height: 6px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 1px;
  }

  /* ë°°í„°ë¦¬ í…ìŠ¤íŠ¸ */
  #batteryText {
    min-width: 40px;
    font-weight: 500;
  }

  /* ë¡œê³  ì»¨í…Œì´ë„ˆ */
  .logo-container {
    display: flex;
    align-items: center;
    gap: 6px;
    padding-left: 4px;
    border-left: 1px solid rgba(255, 255, 255, 0.2);
  }

  /* ë¡œê³  ì•„ì´ì½˜ */
  .icon {
    height: 18px;
    width: auto;
    opacity: 0.8;
    transition: all 0.2s ease;
    filter: brightness(0.9);
  }

  .icon:hover {
    opacity: 1;
    transform: scale(1.1);
    filter: brightness(1.2);
  }

  /* íˆ´íŒ */
  [data-tooltip] {
    position: relative;
    cursor: help;
  }

  [data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 30px;
    right: 0;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 10000;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
</style>
</head>
<body>

<div id="overlay">

  <!-- GPS ê±°ë¦¬ -->
  <div id="distance" data-tooltip="ì˜¤ëŠ˜ ì´ë™ ê±°ë¦¬">
    0.00 km
  </div>

  <!-- ë‚ ì”¨ -->
  <div id="weather" data-tooltip="í˜„ì¬ ë‚ ì”¨">
    ğŸŒ¡ï¸ --
  </div>

  <!-- ì‹œê°„ -->
  <div id="time" data-tooltip="í˜„ì¬ ì‹œê°„">
    ğŸ• --
  </div>

  <!-- ë°°í„°ë¦¬ -->
  <div class="battery-container" data-tooltip="ë°°í„°ë¦¬ ì”ëŸ‰">
    <div id="batteryIcon">
      <div id="batteryFill"></div>
      <div id="batteryBolt">âš¡</div>
      <div id="batteryCap"></div>
    </div>
    <div id="batteryText">--%</div>
  </div>

  <!-- ë¡œê³  -->
  <div class="logo-container">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%88%B2%EB%A1%9C%EA%B3%A0.png" alt="ìˆ²" title="ìˆ²">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%B9%98%EC%A7%80%EC%A7%81%EB%A1%9C%EA%B3%A0.png" alt="ì¹˜ì§€ì§" title="ì¹˜ì§€ì§">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%ED%8A%B8%EC%9C%84%EC%B9%98%EB%A1%9C%EA%B3%A0.png" alt="Twitch" title="Twitch">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%9C%A0%ED%8A%9C%EB%B8%8C%EB%A1%9C%EA%B3%A0.png" alt="YouTube" title="YouTube">
  </div>

</div>

<script type="module">
/* ======================
   Firebase ì„¤ì •
====================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyA5hMmN9QFgdFtaA5gicS_pj-blu_jJdvE",
  authDomain: "rider-bf48b.firebaseapp.com",
  databaseURL: "https://rider-bf48b-default-rtdb.firebaseio.com",
  projectId: "rider-bf48b",
  storageBucket: "rider-bf48b.firebasestorage.app",
  messagingSenderId: "1026929653322",
  appId: "1:1026929653322:web:b90541cccba5b4186198b3"
};

// Firebase ì´ˆê¸°í™”
let db;
try {
  const app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  console.log('ğŸ”¥ Firebase ì—°ê²° ì„±ê³µ');
} catch (error) {
  console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
}

// ë°°í„°ë¦¬ ë°ì´í„° ìˆ˜ì‹ 
if (db) {
  onValue(ref(db, "battery"), (snapshot) => {
    if (!snapshot.exists()) return;
    const data = snapshot.val();
    if (data && typeof data.level === 'number') {
      updateBattery(data.level, data.charging || false);
    }
  }, (error) => {
    console.error('âŒ ë°°í„°ë¦¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
  });
}

/* ======================
   ë°°í„°ë¦¬ ì—…ë°ì´íŠ¸
====================== */
function updateBattery(level, charging) {
  const batteryText = document.getElementById('batteryText');
  const batteryFill = document.getElementById('batteryFill');
  const batteryBolt = document.getElementById('batteryBolt');
  
  // ë ˆë²¨ ì œí•œ
  level = Math.min(100, Math.max(0, level));
  
  batteryText.innerText = level + '%';
  batteryFill.style.width = level + '%';
  batteryFill.style.background = getBatteryColor(level);
  batteryBolt.style.display = charging ? 'flex' : 'none';
}

/* ë°°í„°ë¦¬ ìƒ‰ìƒ */
function getBatteryColor(level) {
  if (level >= 90) return "#4cff4c";
  if (level >= 80) return "#6eff4c";
  if (level >= 70) return "#8fff4c";
  if (level >= 60) return "#b0ff4c";
  if (level >= 50) return "#d1ff4c";
  if (level >= 40) return "#f2ff4c";
  if (level >= 30) return "#ffd24c";
  if (level >= 20) return "#ffa54c";
  if (level >= 10) return "#ff784c";
  return "#ff4c4c";
}

/* ======================
   GPS ê±°ë¦¬ ê³„ì‚° (ì†ë„ ê³„ì‚° ì œê±°)
====================== */
let totalDistance = 0;
let previousLocation = null;
let lastUpdateTime = 0;
const GPS_TIMEOUT = 300000; // 5ë¶„

// ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Î”Ï†/2) ** 2 +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î»/2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // ë¯¸í„°
}

// ê±°ë¦¬ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateDistanceDisplay() {
  const distanceEl = document.getElementById('distance');
  if (distanceEl) {
    distanceEl.innerText = totalDistance.toFixed(2) + ' km';
  }
}

// GPS ì‹ í˜¸ ì²´í¬
setInterval(() => {
  if (lastUpdateTime > 0 && Date.now() - lastUpdateTime > GPS_TIMEOUT) {
    console.log('âš ï¸ GPS ì‹ í˜¸ ì—†ìŒ');
    document.getElementById('distance').innerHTML = 'â¸ï¸ ì‹ í˜¸ì—†ìŒ';
  }
}, 1000);

// RealtimeIRL GPS ìˆ˜ì‹  (ì†ë„ ê³„ì‚° ì œê±°)
try {
  RealtimeIRL.forPullKey("zeoeyze9htbyx455").addLocationListener((location) => {
    const now = Date.now();
    lastUpdateTime = now;
    
    if (location.latitude && location.longitude) {
      if (previousLocation) {
        const distance = calculateDistance(
          previousLocation.latitude,
          previousLocation.longitude,
          location.latitude,
          location.longitude
        );
        
        // ë¯¸í„°ë¥¼ í‚¬ë¡œë¯¸í„°ë¡œ ë³€í™˜í•˜ì—¬ ëˆ„ì 
        totalDistance += distance / 1000;
      }
      previousLocation = location;
      updateDistanceDisplay();
    }
  });
  console.log('ğŸ“ GPS ì—°ê²° ì‹œì‘');
} catch (error) {
  console.error('âŒ GPS ì˜¤ë¥˜:', error);
  document.getElementById('distance').innerText = 'GPS ì˜¤ë¥˜';
}

/* ======================
   ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ê±°ë¦¬ ì €ì¥
====================== */
window.addEventListener('beforeunload', () => {
  localStorage.setItem('totalDistance', totalDistance.toString());
});

// ì €ì¥ëœ ê±°ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
const savedDistance = localStorage.getItem('totalDistance');
if (savedDistance) {
  totalDistance = parseFloat(savedDistance);
  updateDistanceDisplay();
}

/* ======================
   ì‹œê°„ ì—…ë°ì´íŠ¸
====================== */
function updateTime() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('ko-KR', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: true
  });
  document.getElementById('time').innerHTML = `ğŸ• ${timeStr}`;
}
updateTime();
setInterval(updateTime, 1000);

/* ======================
   ë‚ ì”¨ ì—…ë°ì´íŠ¸
====================== */
const WEATHER_API = "3a4a39b054762e36581605681026ed35";
const CITY = "Sejong";

async function updateWeather() {
  try {
    const response = await fetch(
      `https://api.openweathermap.org/data/2.5/weather?q=${CITY}&appid=${WEATHER_API}&units=metric&lang=kr`
    );
    
    if (!response.ok) throw new Error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ');
    
    const data = await response.json();
    const temp = Math.round(data.main.temp);
    const weatherEmoji = getWeatherEmoji(data.weather[0].icon);
    
    document.getElementById('weather').innerHTML = 
      `${weatherEmoji} ${temp}Â°C`;
      
  } catch (error) {
    console.error('âŒ ë‚ ì”¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    document.getElementById('weather').innerHTML = 'ğŸŒ¡ï¸ --Â°C';
  }
}

// ë‚ ì”¨ ì•„ì´ì½˜ ë§¤í•‘
function getWeatherEmoji(iconCode) {
  const map = {
    '01d': 'â˜€ï¸', '01n': 'ğŸŒ™',
    '02d': 'â›…', '02n': 'â˜ï¸',
    '03d': 'â˜ï¸', '03n': 'â˜ï¸',
    '04d': 'â˜ï¸', '04n': 'â˜ï¸',
    '09d': 'ğŸŒ§ï¸', '09n': 'ğŸŒ§ï¸',
    '10d': 'ğŸŒ¦ï¸', '10n': 'ğŸŒ§ï¸',
    '11d': 'â›ˆï¸', '11n': 'â›ˆï¸',
    '13d': 'â„ï¸', '13n': 'â„ï¸',
    '50d': 'ğŸŒ«ï¸', '50n': 'ğŸŒ«ï¸'
  };
  return map[iconCode] || 'ğŸŒ¡ï¸';
}

updateWeather();
setInterval(updateWeather, 600000); // 10ë¶„ë§ˆë‹¤

console.log('âœ… í”„ë­í¬ ì˜¤ë²„ë ˆì´ ë¡œë“œ ì™„ë£Œ');
</script>

</body>
</html>
