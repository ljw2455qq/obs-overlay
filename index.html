<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>í”„ë­í¬ ì˜¤ë²„ë ˆì´ (GPS ì´ë™ê±°ë¦¬)</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: transparent;
    color: white;
  }

  /* í•˜ë‹¨ë°” */
  #overlay {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 38px;
    background: rgba(0, 0, 0, 0.70);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 25px;
    font-size: 15px;
    padding: 0 15px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
  }

  .section {
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  .icon {
    height: 20px;
    opacity: 0.9;
    transition: opacity 0.3s ease;
  }

  .icon:hover {
    opacity: 1;
  }

  /* ê±°ë¦¬ ê°•ì¡° */
  #distance {
    font-weight: 600;
    color: #00ff88;
    text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
  }

  /* ìƒíƒœ í‘œì‹œ */
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4CAF50;
    display: inline-block;
    margin-right: 4px;
    animation: pulse 2s infinite;
  }

  .status-dot.connecting {
    background: #FF9800;
  }

  .status-dot.error {
    background: #F44336;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  /* ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    #overlay {
      gap: 15px;
      font-size: 13px;
    }
    .icon {
      height: 18px;
    }
  }
</style>
</head>

<body>

<!-- ğŸ“Œ í•˜ë‹¨ ì˜¤ë²„ë ˆì´ -->
<div id="overlay">

  <div class="section" id="distance">
    <span class="status-dot connecting"></span>
    ì´ë™ê±°ë¦¬: 0.0 km
  </div>
  <div class="section" id="weather">ğŸŒ¡ï¸ ë‚ ì”¨: --Â°C</div>
  <div class="section" id="time">ğŸ• ì‹œê°„: --:--</div>
  <div class="section" id="battery">ğŸ”‹ ë°°í„°ë¦¬: --%</div>

  <!-- í”Œë«í¼ ë¡œê³  -->
  <div class="section">
    <img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/3/3f/Twitch_logo_2019.svg" alt="Twitch" title="Twitch" />
    <img class="icon" src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" alt="YouTube" title="YouTube" />
    <img class="icon" src="https://cdn-icons-png.flaticon.com/512/3670/3670157.png" alt="Chzzk" title="ì¹˜ì§€ì§" />
    <img class="icon" src="https://cdn-icons-png.flaticon.com/512/5968/5968764.png" alt="Discord" title="Discord" />
  </div>

</div>


<script src="https://cdn.jsdelivr.net/npm/@rtirl/api@latest/lib/index.min.js"></script>

<script>
/* =========================
    ê¸°ë³¸ ì„¤ì •
========================= */
const PULL_KEY = "zeoeyze9htbyx455";
const WEATHER_API = "3a4a39b054762e36581605681026ed35";

/* =========================
    ì´ë™ê±°ë¦¬ ê³„ì‚° ê´€ë ¨ ë³€ìˆ˜
========================= */
let prevLocation = null;
let totalDistance = 0;
let lastUpdateTime = 0;
let locationUpdateCount = 0;
let isConnected = false;

/* Haversine ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (km ë‹¨ìœ„) */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = ((lat2 - lat1) * Math.PI) / 180;
  const dLon = ((lon2 - lon1) * Math.PI) / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* =========================
    ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
========================= */
function updateStatus(status) {
  const dot = document.querySelector('.status-dot');
  dot.className = 'status-dot ' + status;
}

/* =========================
    GPS ê±°ë¦¬ ë¦¬ì…‹ í•¨ìˆ˜
========================= */
function resetDistance() {
  totalDistance = 0;
  prevLocation = null;
  console.log('ê±°ë¦¬ ì´ˆê¸°í™”ë¨');
  document.querySelector("#distance").innerHTML =
    '<span class="status-dot connecting"></span>ì´ë™ê±°ë¦¬: 0.0 km';
}

/* =========================
    ê±°ë¦¬ í‘œì‹œ ì—…ë°ì´íŠ¸
========================= */
function updateDistanceDisplay() {
  document.querySelector("#distance").innerHTML =
    '<span class="status-dot"></span>ì´ë™ê±°ë¦¬: ' + totalDistance.toFixed(1) + ' km';
  updateStatus('');
}

/* =========================
    realtimeIRL GPS ìˆ˜ì‹ 
========================= */
try {
  RealtimeIRL.forPullKey(PULL_KEY).addLocationListener((loc) => {
    const now = Date.now();
    locationUpdateCount++;

    console.log(`GPS ì—…ë°ì´íŠ¸ #${locationUpdateCount}:`, loc);

    // GPSê°€ 5ì´ˆ ì´ìƒ ëŠê²¼ë‹¤ê°€ ë‹¤ì‹œ ë“¤ì–´ì˜¤ë©´ ê±°ë¦¬ ë¦¬ì…‹
    if (now - lastUpdateTime > 5000 && lastUpdateTime > 0) {
      console.log('GPS ì—°ê²° ëŠê¹€ ê°ì§€, ê±°ë¦¬ ë¦¬ì…‹');
      resetDistance();
    }

    lastUpdateTime = now;
    isConnected = true;
    updateStatus('');

    const { latitude, longitude } = loc;

    if (!latitude || !longitude) {
      console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ GPS ë°ì´í„°:', loc);
      return;
    }

    // ì´ì „ ì¢Œí‘œê°€ ìˆì„ ë•Œ ì´ë™ ê±°ë¦¬ ê³„ì‚°
    if (prevLocation) {
      const d = haversine(
        prevLocation.latitude,
        prevLocation.longitude,
        latitude,
        longitude
      );

      console.log(`ì´ë™ ê±°ë¦¬: ${(d * 1000).toFixed(2)}m`);

      // ì •ìƒ ë²”ìœ„ë¡œ íŒë‹¨ë˜ëŠ” ì´ë™ë§Œ ë”í•¨ (300m ì´í•˜)
      if (d > 0 && d < 0.3) {
        totalDistance += d;
        console.log(`ì´ ê±°ë¦¬: ${totalDistance.toFixed(3)} km`);
      } else if (d >= 0.3) {
        console.warn(`ë¹„ì •ìƒì ì¸ ì´ë™ ê±°ë¦¬ ê°ì§€: ${(d * 1000).toFixed(0)}m - ë¬´ì‹œë¨`);
      }
    }

    prevLocation = { latitude, longitude };
    updateDistanceDisplay();
  });

  console.log('RealtimeIRL ì—°ê²° ì‹œì‘ë¨');
  updateStatus('connecting');

} catch (error) {
  console.error('RealtimeIRL ì—°ê²° ì˜¤ë¥˜:', error);
  document.querySelector("#distance").innerHTML =
    '<span class="status-dot error"></span>ì´ë™ê±°ë¦¬: ì—°ê²° ì‹¤íŒ¨';
  updateStatus('error');
}


/* =========================
    ë‚ ì”¨ ì—…ë°ì´íŠ¸
========================= */
async function updateWeather() {
  const url =
    "https://api.openweathermap.org/data/2.5/weather?q=Sejong,KR&appid=" +
    WEATHER_API +
    "&units=metric&lang=kr";

  try {
    const res = await fetch(url);
    const data = await res.json();

    const temp = Math.round(data.main.temp);
    const description = data.weather[0]?.description || '';
    
    document.getElementById("weather").innerHTML =
      `ğŸŒ¡ï¸ ë‚ ì”¨: ${temp}Â°C ${description}`;
  } catch (e) {
    console.error('ë‚ ì”¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
    document.getElementById("weather").innerHTML = "ğŸŒ¡ï¸ ë‚ ì”¨: --Â°C";
  }
}

updateWeather();
setInterval(updateWeather, 600000); // 10ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸


/* =========================
    ì‹œê°„ (ì˜¤ì „/ì˜¤í›„)
========================= */
function updateTime() {
  const now = new Date();
  let hours = now.getHours();
  const minutes = now.getMinutes().toString().padStart(2, "0");
  const ampm = hours >= 12 ? "ì˜¤í›„" : "ì˜¤ì „";
  hours = hours % 12 || 12;

  document.getElementById("time").innerHTML =
    "ğŸ• ì‹œê°„: " + ampm + " " + hours + ":" + minutes;
}

updateTime();
setInterval(updateTime, 1000);


/* =========================
    ë°°í„°ë¦¬ (ë¸Œë¼ìš°ì €/í° ì§€ì› ê°€ëŠ¥ ì‹œë§Œ)
========================= */
if (navigator.getBattery) {
  navigator.getBattery().then((battery) => {
    function updateBattery() {
      const level = Math.round(battery.level * 100);
      const charging = battery.charging ? 'âš¡' : 'ğŸ”‹';
      document.getElementById("battery").innerHTML =
        charging + " ë°°í„°ë¦¬: " + level + "%";
    }
    battery.addEventListener("levelchange", updateBattery);
    battery.addEventListener("chargingchange", updateBattery);
    updateBattery();
  });
} else {
  document.getElementById("battery").innerHTML = "ğŸ”‹ ë°°í„°ë¦¬: N/A";
}


/* =========================
    ë””ë²„ê¹… ì •ë³´ (5ì´ˆë§ˆë‹¤)
========================= */
setInterval(() => {
  console.log(`[ìƒíƒœ] ì´ ê±°ë¦¬: ${totalDistance.toFixed(3)}km | ì—…ë°ì´íŠ¸: ${locationUpdateCount}íšŒ | ì—°ê²°: ${isConnected ? 'O' : 'X'}`);
}, 5000);


/* =========================
    í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ
========================= */
window.addEventListener('load', () => {
  console.log('í”„ë­í¬ ì˜¤ë²„ë ˆì´ ë¡œë“œ ì™„ë£Œ');
  console.log('PULL_KEY:', PULL_KEY);
});
</script>

</body>
</html>
