<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>í”„ë­í¬ ì˜¤ë²„ë ˆì´ (GPS ì´ë™ê±°ë¦¬)</title>
<script src="https://cdn.jsdelivr.net/npm/@rtirl/api"></script>

<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: transparent;
    color: white;
  }

  /* í•˜ë‹¨ë°” */
  #overlay {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 38px;
    background: rgba(0, 0, 0, 0.70);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 25px;
    font-size: 15px;
    padding: 0 15px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
  }

  .section {
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  .icon {
    height: 20px;
    opacity: 0.9;
    transition: opacity 0.3s ease;
  }

  .icon:hover {
    opacity: 1;
  }

  /* ê±°ë¦¬ ê°•ì¡° */
  #distance {
    font-weight: 600;
    color: #00ff88;
    text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
  }

  /* ìƒíƒœ í‘œì‹œ */
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4CAF50;
    display: inline-block;
    margin-right: 4px;
    animation: pulse 2s infinite;
  }

  .status-dot.connecting {
    background: #FF9800;
  }

  .status-dot.error {
    background: #F44336;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  /* ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    #overlay {
      gap: 15px;
      font-size: 13px;
    }
    .icon {
      height: 18px;
    }
  }
</style>
</head>

<body>

<!-- ğŸ“Œ í•˜ë‹¨ ì˜¤ë²„ë ˆì´ -->
<div id="overlay">

  <div class="section" id="distance">
    <span class="status-dot connecting"></span>
    ì´ë™ê±°ë¦¬: 0.00 km
  </div>
  <div class="section" id="weather">ğŸŒ¡ï¸ ë‚ ì”¨: --Â°C</div>
  <div class="section" id="time">ğŸ• ì‹œê°„: --:--</div>
  <div class="section" id="battery">ğŸ”‹ ë°°í„°ë¦¬: --%</div>

<!-- í”Œë«í¼ ë¡œê³  (GitHub Raw URL - 4ê°œ) -->
  <div class="section">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%88%B2%EB%A1%9C%EA%B3%A0.png" alt="ìˆ²" title="ìˆ²" />
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%B9%98%EC%A7%80%EC%A7%81%EB%A1%9C%EA%B3%A0.png" alt="ì¹˜ì§€ì§" title="ì¹˜ì§€ì§" />
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%ED%8A%B8%EC%9C%84%EC%B9%98%EB%A1%9C%EA%B3%A0.png" alt="Twitch" title="Twitch" />
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%9C%A0%ED%8A%9C%EB%B8%8C%EB%A1%9C%EA%B3%A0.png" alt="YouTube" title="YouTube" />
  </div>
</div>

<script>
/* =========================
    ê¸°ë³¸ ì„¤ì •
========================= */
const PULL_KEY = "zeoeyze9htbyx455";
const WEATHER_API = "3a4a39b054762e36581605681026ed35";

/* =========================
    ì´ë™ê±°ë¦¬ ê³„ì‚° (ì§€ë„ ì½”ë“œì—ì„œ ê²€ì¦ëœ ë°©ì‹)
========================= */
let totalDistance = 0;
let previousLocation = null;
let lastUpdateTime = 0;
const GPS_TIMEOUT = 10000; // 10ì´ˆ ë™ì•ˆ ì‹ í˜¸ ì—†ìœ¼ë©´ ë¦¬ì…‹

// Haversine ê³µì‹ (ì§€ë„ ì½”ë“œì™€ ë™ì¼)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // ë¯¸í„° ë‹¨ìœ„ë¡œ ë°˜í™˜
}

/* =========================
    ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
========================= */
function updateStatus(status) {
  const dot = document.querySelector('.status-dot');
  if (dot) {
    dot.className = 'status-dot';
    if (status) {
      dot.classList.add(status);
    }
  }
}

/* =========================
    ê±°ë¦¬ ì´ˆê¸°í™” í•¨ìˆ˜
========================= */
function resetDistance() {
  totalDistance = 0;
  previousLocation = null;
  console.log('ê±°ë¦¬ ì´ˆê¸°í™”ë¨');
  updateDistanceDisplay();
}

/* =========================
    ê±°ë¦¬ í‘œì‹œ ì—…ë°ì´íŠ¸
========================= */
function updateDistanceDisplay() {
  const distanceEl = document.getElementById('distance');
  distanceEl.innerHTML = 
    '<span class="status-dot"></span>ì´ë™ê±°ë¦¬: ' + totalDistance.toFixed(2) + ' km';
  updateStatus('');
}

/* =========================
    RealtimeIRL GPS ìˆ˜ì‹  (ê²€ì¦ëœ ì½”ë“œ)
========================= */
try {
  RealtimeIRL.forPullKey(PULL_KEY).addLocationListener((location) => {
    const now = Date.now();
    console.log('ìœ„ì¹˜ ìˆ˜ì‹ :', location);
    
    // GPS ì‹ í˜¸ê°€ 10ì´ˆ ì´ìƒ ëŠê²¼ë‹¤ê°€ ë‹¤ì‹œ ë“¤ì–´ì˜¤ë©´ ë¦¬ì…‹
    if (lastUpdateTime > 0 && (now - lastUpdateTime) > GPS_TIMEOUT) {
      console.log('âš ï¸ GPS ì‹ í˜¸ ëŠê¹€ ê°ì§€ - ê±°ë¦¬ ë¦¬ì…‹');
      resetDistance();
    }
    
    lastUpdateTime = now;
    
    if (location.latitude && location.longitude) {
      // ì´ì „ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ê±°ë¦¬ ê³„ì‚°
      if (previousLocation) {
        const distance = calculateDistance(
          previousLocation.latitude, 
          previousLocation.longitude,
          location.latitude, 
          location.longitude
        );
        
        // ë¯¸í„°ë¥¼ í‚¬ë¡œë¯¸í„°ë¡œ ë³€í™˜
        totalDistance += distance / 1000;
        
        console.log(`ì´ë™: ${distance.toFixed(2)}m, ì´: ${totalDistance.toFixed(2)}km`);
      }
      
      // í˜„ì¬ ìœ„ì¹˜ ì €ì¥
      previousLocation = location;
      
      // ê±°ë¦¬ í‘œì‹œ ì—…ë°ì´íŠ¸
      updateDistanceDisplay();
      
      // ìƒíƒœ ì—…ë°ì´íŠ¸
      updateStatus('');
    } else {
      console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ìœ„ì¹˜ ë°ì´í„°');
      updateStatus('error');
    }
  });

  console.log('RealtimeIRL ì—°ê²° ì‹œì‘');
  updateStatus('connecting');

} catch (error) {
  console.error('RealtimeIRL ì˜¤ë¥˜:', error);
  document.getElementById('distance').innerHTML =
    '<span class="status-dot error"></span>ì´ë™ê±°ë¦¬: ì—°ê²° ì‹¤íŒ¨';
  updateStatus('error');
}

/* =========================
    GPS ì‹ í˜¸ ì²´í¬ (1ì´ˆë§ˆë‹¤)
========================= */
setInterval(() => {
  if (lastUpdateTime > 0) {
    const timeSinceLastUpdate = Date.now() - lastUpdateTime;
    
    if (timeSinceLastUpdate > GPS_TIMEOUT) {
      console.log('âš ï¸ GPS ì‹ í˜¸ ì—†ìŒ - ê±°ë¦¬ ë¦¬ì…‹');
      resetDistance();
      lastUpdateTime = 0; // ë‹¤ì‹œ ì²´í¬í•˜ì§€ ì•Šë„ë¡
      updateStatus('error');
      
      const distanceEl = document.getElementById('distance');
      distanceEl.innerHTML = 
        '<span class="status-dot error"></span>ì´ë™ê±°ë¦¬: GPS ì‹ í˜¸ ì—†ìŒ';
    }
  }
}, 1000);

/* =========================
    ë‚ ì”¨ ì—…ë°ì´íŠ¸
========================= */
async function updateWeather() {
  const url =
    "https://api.openweathermap.org/data/2.5/weather?q=Sejong,KR&appid=" +
    WEATHER_API +
    "&units=metric&lang=kr";

  try {
    const res = await fetch(url);
    const data = await res.json();

    const temp = Math.round(data.main.temp);
    const description = data.weather[0]?.description || '';
    
    document.getElementById("weather").innerHTML =
      `ğŸŒ¡ï¸ ë‚ ì”¨: ${temp}Â°C ${description}`;
  } catch (e) {
    console.error('ë‚ ì”¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
    document.getElementById("weather").innerHTML = "ğŸŒ¡ï¸ ë‚ ì”¨: --Â°C";
  }
}

updateWeather();
setInterval(updateWeather, 600000); // 10ë¶„ë§ˆë‹¤


/* =========================
    ì‹œê°„ (ì˜¤ì „/ì˜¤í›„)
========================= */
function updateTime() {
  const now = new Date();
  let hours = now.getHours();
  const minutes = now.getMinutes().toString().padStart(2, "0");
  const ampm = hours >= 12 ? "ì˜¤í›„" : "ì˜¤ì „";
  hours = hours % 12 || 12;

  document.getElementById("time").innerHTML =
    "ğŸ• ì‹œê°„: " + ampm + " " + hours + ":" + minutes;
}

updateTime();
setInterval(updateTime, 1000);


/* =========================
    ë°°í„°ë¦¬
========================= */
if (navigator.getBattery) {
  navigator.getBattery().then((battery) => {
    function updateBattery() {
      const level = Math.round(battery.level * 100);
      const charging = battery.charging ? 'âš¡' : 'ğŸ”‹';
      document.getElementById("battery").innerHTML =
        charging + " ë°°í„°ë¦¬: " + level + "%";
    }
    battery.addEventListener("levelchange", updateBattery);
    battery.addEventListener("chargingchange", updateBattery);
    updateBattery();
  });
} else {
  document.getElementById("battery").innerHTML = "ğŸ”‹ ë°°í„°ë¦¬: N/A";
}


/* =========================
    ë””ë²„ê¹… (5ì´ˆë§ˆë‹¤)
========================= */
setInterval(() => {
  const timeSinceUpdate = lastUpdateTime > 0 ? Math.floor((Date.now() - lastUpdateTime) / 1000) : 0;
  console.log(`[ìƒíƒœ] ì´ ê±°ë¦¬: ${totalDistance.toFixed(3)}km | ì´ì „ìœ„ì¹˜: ${previousLocation ? 'O' : 'X'} | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timeSinceUpdate}ì´ˆ ì „`);
}, 5000);

console.log('í”„ë­í¬ ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™” ì™„ë£Œ');
</script>

</body>
</html>
