<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>프랭크 오버레이 (GPS 이동거리)</title>
<script src="https://cdn.jsdelivr.net/npm/@rtirl/api"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: transparent;
    color: white;
  }

  /* 하단바 */
  #overlay {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 38px;
    background: rgba(0, 0, 0, 0.70);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 25px;
    font-size: 15px;
    padding: 0 15px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
  }

  .section {
    display: flex;
    align-items: center;
    gap: 2px; /* 로고 간 간격 축소 */
    white-space: nowrap;
  }

  /* 로고 크기 완전 동일 + 간격 조정 */
  .icon {
    width: 28px !important;
    height: auto !important;
    opacity: 0.9;
    transition: opacity 0.3s ease;
    object-fit: contain;
    vertical-align: middle;
  }
  .icon:hover {
    opacity: 1;
  }

  /* 거리 강조 */
  #distance {
    font-weight: 600;
    color: #00ff88;
    text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
  }

  /* 상태 도트 */
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4CAF50;
    display: inline-block;
    margin-right: 4px;
    animation: pulse 2s infinite;
  }
  .status-dot.connecting { background: #FF9800; }
  .status-dot.error { background: #F44336; }
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  /* 반응형 */
  @media (max-width: 768px) {
    #overlay {
      gap: 15px;
      font-size: 13px;
    }
    .icon {
      width: 24px !important;
    }
    .section {
      gap: 1px; /* 모바일에서 더 좁게 */
    }
  }
</style>
</head>
<body>
<!-- 하단 오버레이 -->
<div id="overlay">
  <div class="section" id="distance">
    <span class="status-dot connecting"></span>
    이동거리: 0.00 km
  </div>
  <div class="section" id="weather">날씨: --°C</div>
  <div class="section" id="time">시간: --:--</div>
  <div class="section" id="battery">배터리: --%</div>

  <!-- 플랫폼 로고 (간격 좁힘 + 크기 동일) -->
  <div class="section">
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%88%B2%EB%A1%9C%EA%B3%A0.png" alt="숲" title="숲" />
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%B9%98%EC%A7%80%EC%A7%81%EB%A1%9C%EA%B3%A0.png" alt="치지직" title="치지직" />
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%ED%8A%B8%EC%9C%84%EC%B9%98%EB%A1%9C%EA%B3%A0.png" alt="Twitch" title="Twitch" />
    <img class="icon" src="https://raw.githubusercontent.com/ljw2455qq/obs-overlay/main/%EC%9C%A0%ED%8A%9C%EB%B8%8C%EB%A1%9C%EA%B3%A0.png" alt="YouTube" title="YouTube" />
  </div>
</div>

<script>
/* =========================
    기본 설정
========================= */
const PULL_KEY = "zeoeyze9htbyx455";
const WEATHER_API = "3a4a39b054762e36581605681026ed35";

/* =========================
    이동거리 계산
========================= */
let totalDistance = 0;
let previousLocation = null;
let lastUpdateTime = 0;
const GPS_TIMEOUT = 10000;

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* =========================
    상태 업데이트
========================= */
function updateStatus(status) {
  const dot = document.querySelector('.status-dot');
  if (dot) {
    dot.className = 'status-dot';
    if (status) dot.classList.add(status);
  }
}
function resetDistance() {
  totalDistance = 0;
  previousLocation = null;
  updateDistanceDisplay();
}
function updateDistanceDisplay() {
  const el = document.getElementById('distance');
  el.innerHTML = '<span class="status-dot"></span>이동거리: ' + totalDistance.toFixed(2) + ' km';
  updateStatus('');
}

/* =========================
    RealtimeIRL GPS
========================= */
try {
  RealtimeIRL.forPullKey(PULL_KEY).addLocationListener((location) => {
    const now = Date.now();
    if (lastUpdateTime > 0 && (now - lastUpdateTime) > GPS_TIMEOUT) {
      resetDistance();
    }
    lastUpdateTime = now;

    if (location.latitude && location.longitude) {
      if (previousLocation) {
        const dist = calculateDistance(
          previousLocation.latitude, previousLocation.longitude,
          location.latitude, location.longitude
        );
        totalDistance += dist / 1000;
      }
      previousLocation = location;
      updateDistanceDisplay();
      updateStatus('');
    } else {
      updateStatus('error');
    }
  });
  updateStatus('connecting');
} catch (e) {
  document.getElementById('distance').innerHTML = '<span class="status-dot error"></span>이동거리: 연결 실패';
  updateStatus('error');
}

/* GPS 신호 체크 */
setInterval(() => {
  if (lastUpdateTime > 0 && (Date.now() - lastUpdateTime) > GPS_TIMEOUT) {
    resetDistance();
    lastUpdateTime = 0;
    updateStatus('error');
    document.getElementById('distance').innerHTML = '<span class="status-dot error"></span>이동거리: GPS 신호 없음';
  }
}, 1000);

/* =========================
    날씨
========================= */
async function updateWeather() {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Sejong,KR&appid=${WEATHER_API}&units=metric&lang=kr`);
    const data = await res.json();
    const temp = Math.round(data.main.temp);
    const desc = data.weather[0]?.description || '';
    document.getElementById("weather").innerHTML = `날씨: ${temp}°C ${desc}`;
  } catch (e) {
    document.getElementById("weather").innerHTML = "날씨: --°C";
  }
}
updateWeather();
setInterval(updateWeather, 600000);

/* =========================
    시간
========================= */
function updateTime() {
  const now = new Date();
  let h = now.getHours();
  const m = now.getMinutes().toString().padStart(2, "0");
  const ampm = h >= 12 ? "오후" : "오전";
  h = h % 12 || 12;
  document.getElementById("time").innerHTML = `시간: ${ampm} ${h}:${m}`;
}
updateTime();
setInterval(updateTime, 1000);

/* =========================
    배터리
========================= */
if (navigator.getBattery) {
  navigator.getBattery().then(battery => {
    function update() {
      const level = Math.round(battery.level * 100);
      const icon = battery.charging ? '충전 중' : '배터리';
      document.getElementById("battery").innerHTML = `${icon}: ${level}%`;
    }
    battery.addEventListener("levelchange", update);
    battery.addEventListener("chargingchange", update);
    update();
  });
} else {
  document.getElementById("battery").innerHTML = "배터리: N/A";
}

/* 디버깅 */
setInterval(() => {
  const ago = lastUpdateTime > 0 ? Math.floor((Date.now() - lastUpdateTime)/1000) : 0;
  console.log(`[상태] 거리: ${totalDistance.toFixed(3)}km | 업데이트: ${ago}초 전`);
}, 5000);

console.log('프랭크 오버레이 초기화 완료');
</script>
</body>
</html>
