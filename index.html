<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>프랭크형 오버레이</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@rtirl/api@latest/lib/index.min.js"></script>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: "Pretendard", sans-serif;
        color: white;
      }

      #overlay {
        position: absolute;
        bottom: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.6);
        font-size: 16px;
        display: flex;
        align-items: center;
        padding: 4px 8px;
      }

      .section {
        margin-right: 14px;
        display: flex;
        align-items: center;
      }

      .section img {
        height: 20px;
        margin-right: 6px;
      }

      #map {
        position: absolute;
        right: 20px;
        bottom: 10px;
        width: 230px;
        height: 190px;
        border-radius: 10px;
        overflow: hidden;
      }

      #marker {
        background-image: url("profile.png");
        background-size: cover;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid white;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div id="overlay">
      <div class="section" id="distance">이동거리: 0.0 km</div>
      <div class="section" id="weather">날씨: --°C</div>
      <div class="section" id="time">시간: --:--</div>
      <div class="section" id="battery">배터리: --%</div>
      <div class="section" id="signal">신호: ✅</div>
      <div class="section">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/3f/Twitch_logo_2019.svg" />
        <img src="https://static.cdnlogo.com/logos/y/96/youtube-icon.svg" />
        <img src="https://static.cdnlogo.com/logos/z/98/zz-icon.svg" />
        <img src="https://static.cdnlogo.com/logos/m/52/meta.svg" />
      </div>
    </div>

    <script>
      const MAPBOX_TOKEN =
        "pk.eyJ1IjoiaG9vbmNvbSIsImEiOiJjbWNjM3R4enUwM3pnMmlxMWJvZTVrMWIzIn0.h_-BNK4FuriEfFWXvE1pmw";
      const PULL_KEY = "zeoeyze9htbyx455";
      const WEATHER_API = "3a4a39b054762e36581605681026ed35";

      // 지도 설정
      mapboxgl.accessToken = MAPBOX_TOKEN;
      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v12",
        center: [127.2664, 36.4800], // 세종시 중심
        zoom: 14,
        attributionControl: false,
      });

      // 마커
      const el = document.createElement("div");
      el.id = "marker";
      const marker = new mapboxgl.Marker(el).setLngLat([127.2664, 36.4800]).addTo(map);

      // 이동 거리 계산
      let prevLocation = null;
      let totalDistance = 0;
      function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371; // km
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      RealtimeIRL.forPullKey(PULL_KEY).addLocationListener((loc) => {
        const { latitude, longitude } = loc;
        marker.setLngLat([longitude, latitude]);
        map.panTo([longitude, latitude]);

        if (prevLocation) {
          const d = haversine(
            prevLocation.latitude,
            prevLocation.longitude,
            latitude,
            longitude
          );
          if (d < 0.5) totalDistance += d; // 500m 이상 급이동은 무시
        }
        prevLocation = { latitude, longitude };
        document.getElementById("distance").innerText =
          "이동거리: " + totalDistance.toFixed(1) + " km";
      });

      // 날씨 업데이트
      async function updateWeather() {
        const url =
          "https://api.openweathermap.org/data/2.5/weather?q=Sejong,KR&appid=" +
          WEATHER_API +
          "&units=metric&lang=kr";
        const res = await fetch(url);
        const data = await res.json();
        document.getElementById("weather").innerText =
          "날씨: " + Math.round(data.main.temp) + "°C";
      }
      updateWeather();
      setInterval(updateWeather, 600000); // 10분마다 갱신

      // 시간 표시 (오전/오후)
      function updateTime() {
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, "0");
        const ampm = hours >= 12 ? "오후" : "오전";
        hours = hours % 12 || 12;
        document.getElementById("time").innerText =
          "시간: " + ampm + " " + hours + ":" + minutes;
      }
      setInterval(updateTime, 1000);
      updateTime();

      // 배터리 상태
      navigator.getBattery?.().then((battery) => {
        function updateBattery() {
          document.getElementById("battery").innerText =
            "배터리: " + Math.round(battery.level * 100) + "%";
        }
        battery.addEventListener("levelchange", updateBattery);
        updateBattery();
      });
    </script>
  </body>
</html>
